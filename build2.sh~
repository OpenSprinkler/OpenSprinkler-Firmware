#!/bin/bash

echo "Compiling firmware..."

ADS1115=""
ADS1115FILES=""
PCF8591=""
PCF8591FILES=""
LIB=""

i2cdetect -y 1 |grep "48 --" >/dev/null
if [ "$?" -eq 0 ]; then
	echo "found ADS1115"
	ADS1115="-DADS1115"
	ADS1115FILES="./ospi-analog/driver_ads1115*.c ./ospi-analog/iic.c"
	LIB="-lgpiod"
fi
	
i2cdetect -y 1 |grep "48 49" >/dev/null
if [ "$?" -eq 0 ]; then
	echo "found PCF8591"
	PCF8591="-DPCF8591"
	PCF8591FILES="./ospi-analog/driver_pcf8591*.c ./ospi-analog/iic.c"
	LIB="-lgpiod"
fi
	
g++ -o OpenSprinkler -DOSPI $ADS1115 $PCF8591 -std=c++14 \
	main.cpp OpenSprinkler.cpp program.cpp opensprinkler_server.cpp \
	utils.cpp weather.cpp gpio.cpp etherport.cpp mqtt.cpp sensor*.cpp \
	$ADS1115FILES $PCF8591FILES \
	-li2c -lpthread -lmosquitto -lcrypto -lssl $LIB
